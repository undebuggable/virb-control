/*Pawe≈Ç Owczarek*/
/*virb-control 2017-10-30*/
function VirbControlForm(a){function b(a){var b=k.getElementsByTagName("input");Array.prototype.forEach.call(b,function(b){a&&b.setAttribute("disabled","true"),a||b.removeAttribute("disabled")})}function c(a){var b=k.getElementsByTagName("fieldset");Array.prototype.forEach.call(b,function(b){b.style.display=a?"block":"none"})}function d(){[m,n].forEach(function(a){for(;a.childNodes.length;)a.removeChild(a.firstChild)})}function e(a){var b=1==+a.type?n:2==+a.type?m:null;b&&b.appendChild(h(a))}function f(a,b){var c=new CustomEvent(a,{detail:b});k.dispatchEvent(c)}function g(a){var c,d,e=a.target,g=e.type,h=e.checked,i=e.value,j=e.name;"button"==g?~[CONFIG.COMMAND.RECORD_START.command,CONFIG.COMMAND.RECORD_STOP.command,CONFIG.COMMAND.PICTURE.command].indexOf(j)?(d={command:j},j==CONFIG.COMMAND.PICTURE.command&&(d[CONFIG.KEY.STATUS_TIMER]=Array.prototype.filter.call(k.querySelectorAll("input[name="+CONFIG.KEY.STATUS_TIMER+"]"),function(a){return a.checked})[0].value),console.log("Controlling the device\t"+JSON.stringify(d)),f(CONFIG.EVENT_INPUT_CLICK,d),b(!0)):"export-status"==j&&f(CONFIG.EVENT_EXPORT_HISTORY):("checkbox"==g&&(c=+h+""),"radio"==g&&(c=i),CONFIG.COMMAND.UPDATE.feature=j,CONFIG.COMMAND.UPDATE.value=c,console.log("Updating the feature\t"+JSON.stringify(CONFIG.COMMAND.UPDATE)),f(CONFIG.EVENT_INPUT_CLICK,CONFIG.COMMAND.UPDATE),b(!0))}function h(a){var b=k.createDocumentFragment();switch(+a.type){case 1:var c=k.createElement("fieldset"),d=k.createElement("legend");d.textContent=a.feature,c.appendChild(d),a.options.forEach(function(b,d){var e,f,h;f=k.createElement("p"),h=k.createElement("input"),e=k.createElement("label"),h.setAttribute("type","radio"),h.setAttribute("id",a.feature+"-"+b),h.setAttribute("value",b),h.setAttribute("name",a.feature),h.addEventListener(CONFIG.EVENT_CLICK,g,!1),h.addEventListener(CONFIG.EVENT_TAP,g,!1),b==a.value&&h.setAttribute("checked","true"),e.textContent=b.concat(CONFIG.KEY.FEATURE_SUMMARIES in a?" ("+a[CONFIG.KEY.FEATURE_SUMMARIES][d]+")":""),e.setAttribute("for",a.feature+"-"+b),f.appendChild(h),f.appendChild(e),c.appendChild(f)}),b.appendChild(c);break;case 2:var e=k.createElement("input"),f=k.createElement("label"),h=k.createElement("p");e.setAttribute("type","checkbox"),e.setAttribute("id",a.feature),e.setAttribute("name",a.feature),a.value==a.enabled&&e.setAttribute("checked","true"),e.setAttribute("value",a.feature),e.addEventListener(CONFIG.EVENT_CLICK,g,!1),e.addEventListener(CONFIG.EVENT_TAP,g,!1),f.textContent=a.feature,f.setAttribute("for",a.feature),h.appendChild(e),h.appendChild(f),b.appendChild(h)}return b}var i,j=a,k=j.document,l=k.getElementById(CONFIG.ID.FORM),m=l.querySelector("#"+CONFIG.ID.DEVICE_ONOFF),n=l.querySelector("#"+CONFIG.ID.ELEM_DEVICE_MULTIOPTION);return function(){if(!a)throw new Error(CONFIG.EXCEPTION.WINDOW_NOT_FOUND);i={clear:d,showAllFieldsets:c,disableAllInputs:b,renderConfigurationFeatureUI:e,onInputClick:g}}(),i}function VirbControlStatus(a){if(!a)throw new Error(CONFIG.EXCEPTION.WINDOW_NOT_FOUND);var b=this,c=a.document;b.elemDocument=c,b.elemStatus=c.querySelector("#"+CONFIG.ID.ELEM_DEVICE_STATUS),b.elemInfo=c.querySelector("#"+CONFIG.ID.ELEM_DEVICE_INFO),b.elemPreview=c.querySelector("#"+CONFIG.ID.ELEM_DEVICE_PREVIEW)}function VirbControl(a){function b(){var a=n.getElementsByTagName("input");Array.prototype.forEach.call(a,function(a){"button"!=a.type&&(a.removeEventListener(CONFIG.EVENT_CLICK,s.onInputClick,!1),a.removeEventListener(CONFIG.EVENT_TAP,s.onInputClick,!1))})}function c(){p.forEach(function(a){}),p=[]}function d(){b(),s.clear(),t.clear(),n.body.classList.add(CONFIG.CSS.DETECTING)}function e(){if(r.readyState==XMLHttpRequest.DONE){var a,b=t.elemStatus;if(r.responseText.length){for(q&&(n.body.classList.remove(CONFIG.CSS.DETECTING),Array.prototype.forEach.call(n.getElementsByTagName("input"),function(a){a.addEventListener(CONFIG.EVENT_CLICK,s.onInputClick,!1),a.addEventListener(CONFIG.EVENT_TAP,s.onInputClick,!1)}),setTimeout(i.bind({virbCommand:CONFIG.COMMAND.INFO}),50),setTimeout(i.bind({virbCommand:CONFIG.COMMAND.PREVIEW}),350),setTimeout(i.bind({virbCommand:CONFIG.COMMAND.FEATURES}),650),q=!1),a=JSON.parse(r.responseText),a.isoTime=(new Date).toISOString(),p.push(a);b.childNodes.length;)b.removeChild(b.firstChild);t.renderConfigurationFeatureUI(a,t.elemStatus)}else q=!0,d(),s.showAllFieldsets(!1)}}function f(){if(this.readyState==XMLHttpRequest.DONE){if(console.log("onStateChangeGet\n"+this.responseText),!this.responseText.length)return void(l.IS_GETTING=!1);var a=JSON.parse(this.responseText),c=Object.keys(a);if(1==+a.result)switch(s.disableAllInputs(!1),c.splice(c.indexOf("result"),1),c[0]){case CONFIG.RESPONSE.FEATURES:b(),s.clear(),a.features.forEach(function(a){s.renderConfigurationFeatureUI(a)}),s.showAllFieldsets(!0);break;case CONFIG.RESPONSE.INFO:b(),t.elemInfo.innerHTML="",a.deviceInfo.forEach(function(a){t.renderConfigurationFeatureUI(a,t.elemInfo)});break;case CONFIG.RESPONSE.PREVIEW:b(),t.elemPreview.innerHTML="";var d=n.createElement("a"),e=n.createElement("span");d.title=a.url,d.textContent=a.url,d.href=a.url,t.elemPreview.appendChild(d),e.textContent=" ("+CONFIG.UI.STREAMING_NOTICE+")",t.elemPreview.appendChild(e)}l.IS_GETTING=!1}}function g(){if(this.readyState==XMLHttpRequest.DONE){if(console.log("onStateChangeGet\n"+this.responseText),!this.responseText.length)return void(l.IS_SETTING=!1);var a=JSON.parse(this.responseText),c=Object.keys(a);switch(s.disableAllInputs(!1),+a.result){case 0:alert(CONFIG.UI.FAILED_TO_UPDATE)}switch(c.splice(c.indexOf("result"),1),c[0]){case CONFIG.RESPONSE.FEATURES:b(),s.clear(),a.features.forEach(function(a){s.renderConfigurationFeatureUI(a)}),s.showAllFieldsets(!0)}l.IS_SETTING=!1}}function h(a){l.IS_SETTING=!0;var b=new XMLHttpRequest,c=a.detail;b.addEventListener(CONFIG.EVENT_STATE_CHANGE,g,!1),b.open(CONFIG.HTTP_METHOD_DEFAULT,CONFIG.URL_VIRB.,!0),b.setRequestHeader(CONFIG.HTTP_CONTENT_TYPE,CONFIG.MIME_JSON),b.send(JSON.stringify(c))}function i(a){l.IS_GETTING=!0,a||(a=this.virbCommand);var b=new XMLHttpRequest;b.addEventListener(CONFIG.EVENT_STATE_CHANGE,f,!1),b.open(CONFIG.HTTP_METHOD_DEFAULT,CONFIG.URL_VIRB.,!0),b.setRequestHeader(CONFIG.HTTP_CONTENT_TYPE,CONFIG.MIME_JSON),b.send(JSON.stringify(a))}function j(){l.IS_GETTING||l.IS_SETTING||(r.open(CONFIG.HTTP_METHOD_DEFAULT,CONFIG.URL_VIRB.,!0),r.setRequestHeader(CONFIG.HTTP_CONTENT_TYPE,CONFIG.MIME_JSON),r.send(JSON.stringify(CONFIG.COMMAND.STATUS)))}var k=null,l={IS_GETTING:!1,IS_SETTING:!1},m=a,n=m.document,o={},p=[],q=!0,r=new XMLHttpRequest,s=new VirbControlForm(m),t=new VirbControlStatus(m);return function(){o={},n.addEventListener(CONFIG.EVENT_INPUT_CLICK,h),n.addEventListener(CONFIG.EVENT_EXPORT_HISTORY,c),r.addEventListener(CONFIG.EVENT_STATE_CHANGE,e,!1),k=setInterval(j,1352)}(),o}var CONFIG.HTTP_METHOD_POST="POST",CONFIG.HTTP_METHOD_DEFAULT=CONFIG.HTTP_METHOD_POST,CONFIG.HTTP_CONTENT_TYPE="Content-Type",CONFIG.MIME_JSON="application/json",CONFIG.EVENT_EXPORT_HISTORY="virb-control-export-history",CONFIG.EVENT_INPUT_CLICK="virb-control-input-click",CONFIG.EVENT_GET_COMPLETE="virb-control-get-complete",CONFIG.EVENT_SET_COMPLETE="virb-control-set-complete",CONFIG.EVENT_CLICK="click",CONFIG.EVENT_TAP="tap",CONFIG.EVENT_STATE_CHANGE="readystatechange",CONFIG.EVENT_LOAD="load",EXCEPTION={WINDOW_NOT_FOUND:"The browser window not found"},ID={FORM:"virb-control-form",DEVICE_ONOFF:"device-features-onoff",ELEM_DEVICE_MULTIOPTION:"device-features-multioption",ELEM_DEVICE_STATUS:"device-status",ELEM_DEVICE_INFO:"device-info",ELEM_DEVICE_PREVIEW:"device-preview",DEVICE_CONTROL:"device-features-control"},CSS={DETECTING:"detecting"},KEY={FEATURE_SUMMARIES:"optionSummaries",STATUS_TIMER:"selfTimer",STATUS_SPACE_AVAILABLE:"availableSpace",STATUS_SPACE_TOTAL:"totalSpace",STATUS_TIME_RECORDING:"recordingTime",STATUS_TIME_REMAINING:"recordingTimeRemaining"},UI={STREAMING_NOTICE:"Starting the streaming will stop recording and repeated pictures",DETECTING:"Detecting the camera...",FAILED_TO_UPDATE:"Failed to update the command"},COMMAND={FEATURES:{command:"features"},UPDATE:{command:"updateFeature",feature:null,value:null},RECORD_START:{command:"startRecording"},RECORD_STOP:{command:"stopRecording"},STATUS:{command:"status"},INFO:{command:"deviceInfo"},PREVIEW:{command:"livePreview",streamType:"rtp"},PICTURE:{command:"snapPicture",selfTimer:0}},RESPONSE={FEATURES:"features",STATUS:"status",INFO:"deviceInfo",PREVIEW:"url"},CONFIG.URL_VIRB.="http://192.168.0.1/virb",PROFILES={VIDEO_CAR:[{gps:"whenrecording"},{recordingLED:"1"},{videoMode:"1080p"},{fieldOfView:"ultraZoom"},{videoLoop:"30"},{microphone:"1"},{stabilization:"1"},{rotation:"1"}],VIDEO_NORMAL:[],TIMELAPSE_VIDEO:[{gps:"off"},{recordingLED:"0"},{videoMode:"1080p"},{fieldOfView:"ultraZoom"},{videoLoop:"0"},{microphone:"0"},{imageSize:"4664x3496"},{stabilization:"0"},{rotation:"1"}],TIMELAPSE_PHOTO:[]};VirbControlStatus.prototype.clear=function(){[this.elemStatus,this.elemPreview,this.elemInfo].forEach(function(a){for(;a.childNodes.length;)a.removeChild(a.firstChild)}),this.elemStatus.textContent=CONFIG.UI.DETECTING},VirbControlStatus.prototype.renderConfigurationFeatureUI=function(a,b){b.appendChild(this.parseResponse(a))},VirbControlStatus.prototype.secondsToTimeString=function(a){var b,c;return c=Math.floor(a/3600),b=Math.floor(a/60)-60*c,a=a-3600*c-60*b,"".concat(c+"h ",b+"min ",a+"sec")},VirbControlStatus.prototype.kilobytesToSpaceString=function(a){var b,c;return c=Math.floor(a/1048576),b=Math.floor(a/1024)-1024*c,a=a-1024*c*1024-1024*b,"".concat(c+"GiB ",b+"MiB ",a+"KiB")},VirbControlStatus.prototype.parseResponse=function(a){var b=this,c=b.elemDocument.createDocumentFragment();a.type;var d,e,f=b.elemDocument.createElement("ol");return Object.keys(a).forEach(function(c){switch(e=b.elemDocument.createElement("dt"),d=b.elemDocument.createElement("dd"),e.textContent=c,c){case CONFIG.KEY.STATUS_SPACE_AVAILABLE:case CONFIG.KEY.STATUS_SPACE_TOTAL:d.textContent=b.kilobytesToSpaceString(+a[c]);break;case CONFIG.KEY.STATUS_TIME_RECORDING:case CONFIG.KEY.STATUS_TIME_REMAINING:d.textContent=b.secondsToTimeString(+a[c]);break;default:d.textContent=a[c]}f.appendChild(e),f.appendChild(d)}),c.appendChild(f),c},function(a){function b(){new VirbControl(c)}var c=a;!function(){c.addEventListener(CONFIG.EVENT_LOAD,b)}()}(window);